<!DOCTYPE html>
<html>

<head>
    <title>schnorarr Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1b;
            color: #d7dadc;
            padding: 40px;
            line-height: 1.6;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        pre {
            background: #272729;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #343536;
            overflow: auto;
            font-size: 12px;
            color: #818384;
        }

        h1 {
            color: #ff4500;
            margin: 0;
        }

        h2 {
            color: #d7dadc;
            margin-top: 40px;
            border-left: 4px solid #4caf50;
            padding-left: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
        }

        .status-bar {
            background: #272729;
            padding: 15px 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #343536;
        }

        .status-badge {
            background: #0079d3;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .file-list {
            list-style: none;
            padding: 0;
        }

        .timestamp {
            color: #818384;
        }

        .badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
        }

        .badge-added {
            background: #4caf50;
        }

        .badge-deleted {
            background: #f44336;
        }

        .path-cell {
            color: #0079d3;
            word-break: break-all;
        }

        .history-link {
            font-size: 12px;
            color: #0079d3;
            text-decoration: none;
            font-weight: bold;
            border: 1px solid #343536;
            padding: 4px 10px;
            border-radius: 4px;
        }

        .history-link:hover {
            background: #343536;
        }

        /* Chart CSS */
        .chart-container {
            display: flex;
            align-items: flex-end;
            height: 150px;
            gap: 10px;
            padding: 10px;
            border: 1px solid #343536;
            background: #272729;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .chart-bar {
            flex: 1;
            background: #4caf50;
            border-radius: 4px 4px 0 0;
            transition: height 0.3s ease;
            position: relative;
            min-height: 4px;
            /* Ensure 0 values have a line */
        }

        .chart-bar:hover {
            background: #66bb6a;
        }

        .chart-label {
            text-align: center;
            font-size: 10px;
            color: #818384;
            margin-top: 5px;
        }

        .chart-value {
            position: absolute;
            top: -20px;
            width: 100%;
            text-align: center;
            font-size: 10px;
            color: white;
            display: none;
        }

        .chart-bar:hover .chart-value {
            display: block;
        }

        /* UX: Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .toast {
            background: #272729;
            color: #d7dadc;
            padding: 12px 20px;
            border-radius: 4px;
            border-left: 4px solid #0079d3;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            font-size: 14px;
            animation: slideIn 0.3s ease-out;
            min-width: 200px;
        }

        .toast.success {
            border-left-color: #4caf50;
        }

        .toast.error {
            border-left-color: #f44336;
        }

        .toast.warning {
            border-left-color: #ffa726;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* UX: Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #272729 25%, #343536 50%, #272729 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            color: transparent !important;
            border-radius: 4px;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* UX: Mobile Layout */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .container {
                width: 100%;
                margin: 0;
            }

            h1 {
                font-size: 24px;
            }

            .status-bar {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            /* Stack Grids */
            div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }

            /* Adjust Chart */
            .chart-container {
                height: 100px;
            }

            /* Buttons */
            a[href="/sync"],
            a[href="/history"] {
                padding: 6px 12px !important;
                font-size: 12px !important;
            }
        }
    </style>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,">
    <!-- <meta http-equiv="refresh" content="5"> Removed for WS -->
</head>

<body>
    <div id="toast-container"></div>
    <div class="container">
        <div
            style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #343536; margin-bottom: 30px; padding-bottom: 10px;">
            <h1>schnorarr Sync Center</h1>
            <div style="display: flex; gap: 15px;">
                <a href="/test-notify"
                    style="padding: 8px 15px; font-size: 12px; border: 1px solid #343536; border-radius: 4px; color: #818384; text-decoration: none;">üîî
                    TEST ALERT</a>
                <a href="/history" class="history-link" style="padding: 8px 20px; font-size: 14px;">üìú FULL HISTORY</a>
                <a href="/sync"
                    style="background: #4caf50; color: white; text-decoration: none; padding: 8px 20px; border-radius: 5px; font-weight: bold; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">‚ö°
                    SYNC NOW</a>
            </div>
        </div>

        <div class="status-bar" style="justify-content: space-between;">
            <div style="display: flex; gap: 10px; align-items: center;">
                {{if .Healthy}}
                <span>Status: <span class='status-badge'>ACTIVE</span></span>
                {{else}}
                <span>Status: <span class='status-badge' style='background: #f44336;'>CRITICAL ERROR</span></span>
                {{end}}
                <a href="/pause" style="margin-left: 10px; font-size: 11px; color: #ffa726; text-decoration: none;">‚è∏Ô∏è
                    PAUSE</a>
                <a href="/resume" style="font-size: 11px; color: #4caf50; text-decoration: none;">‚ñ∂Ô∏è RESUME</a>
            </div>
            <span class="timestamp" style='font-size: 13px;'>Server Time: {{.Time}}</span>
        </div>

        <!-- Traffic Stats -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div
                style="background: #272729; padding: 20px; border-radius: 8px; border: 1px solid #343536; text-align: center;">
                <div style="font-size: 12px; color: #818384; text-transform: uppercase; margin-bottom: 5px;">Traffic
                    Today</div>
                <div style="font-size: 12px; color: #818384; text-transform: uppercase; margin-bottom: 5px;">Traffic
                    Today</div>
                <div id="stat-today" class="skeleton" style="font-size: 24px; color: #4caf50; font-weight: bold;">--
                </div>
            </div>
            <div
                style="background: #272729; padding: 20px; border-radius: 8px; border: 1px solid #343536; text-align: center;">
                <div style="font-size: 12px; color: #818384; text-transform: uppercase; margin-bottom: 5px;">Total
                    Traffic</div>
                <div id="stat-total" class="skeleton" style="font-size: 24px; color: #0079d3; font-weight: bold;">--
                </div>
            </div>
        </div>

        <!-- Current Speed (Added for Fix) -->
        <div
            style="background: #272729; padding: 20px; border-radius: 8px; border: 1px solid #343536; text-align: center; margin-bottom: 30px;">
            <div style="font-size: 12px; color: #818384; text-transform: uppercase; margin-bottom: 5px;">Current Speed
            </div>
            <div id="stat-speed" style="font-size: 32px; color: #e91e63; font-weight: bold;">{{.CurrentSpeed}}</div>
        </div>

        {{if not .Healthy}}
        <div
            style="background: #3e1b1b; color: #ff8a80; padding: 15px; border-radius: 8px; border: 1px solid #c62828; margin-bottom: 20px;">
            <strong>‚ö†Ô∏è SYSTEM ALERT:</strong> {{.LastErrorMsg}}
        </div>
        {{end}}

        <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px;">
            <div>
                <h2>Recent Activity</h2>
                <ul id="history-list" class="file-list">
                    {{range .History}}
                    <li
                        style="display: flex; flex-direction: column; background: #272729; margin-bottom: 15px; padding: 15px; border-radius: 6px; border: 1px solid #343536; border-left: 4px solid #4caf50;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <span class='badge badge-{{.Action}}'>{{.Action}}</span>
                            <span class='timestamp' style='font-size: 11px; color: #818384;'>{{.Time}}</span>
                        </div>
                        <div class='path-cell' style='font-size: 14px; font-weight: 500; letter-spacing: 0.3px;'>
                            {{.Path}}</div>
                    </li>
                    {{else}}
                    <li>No files synced recently.</li>
                    {{end}}
                </ul>
            </div>
            <div>
                <h2>Live Progress</h2>
                {{if .Progress}}
                <div
                    style="background: #272729; padding: 25px; border-radius: 8px; border: 1px solid #343536; border-top: 4px solid #ffa726;">
                    <h3 style="margin-top: 0; color: #ffa726; font-size: 14px; text-transform: uppercase;">Active
                        Transfer</h3>
                    <div
                        style="font-family: monospace; font-size: 13px; color: #ffd54f; margin-bottom: 15px; background: #1a1a1b; padding: 10px; border-radius: 4px; overflow-wrap: break-word;">
                        {{.Progress}}
                    </div>
                    <div style="font-size: 12px; color: #818384; display: flex; justify-content: space-between;">
                        <span>Queue Status: <strong>{{.Queued}} batch(es) pending</strong></span>
                        <span id="eta-display" style="color: #4caf50; font-weight: bold;">ETA: Calculating...</span>
                    </div>
                </div>
                {{else}}
                <div
                    style="background: #272729; padding: 25px; border-radius: 8px; border: 1px solid #343536; border-top: 4px solid #818384; text-align: center; color: #818384;">
                    <div style="font-size: 32px; margin-bottom: 10px;">üí§</div>
                    <div style="font-weight: bold;">System Idle</div>
                    <div style="font-size: 12px; margin-top: 5px;">Queue is empty or waiting for changes.</div>
                </div>
                {{end}}
            </div>
        </div>

        <!-- Settings -->
        <div
            style="background: #272729; padding: 20px; border-radius: 8px; border: 1px solid #343536; margin-bottom: 30px;">
            <h3 style="margin-top: 0; color: #d7dadc; border-bottom: 1px solid #343536; padding-bottom: 10px;">‚öôÔ∏è Sync
                Settings</h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                <!-- BW Limit -->
                <div>
                    <form action="/settings/bwlimit" method="POST"
                        style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="font-size: 13px; color: #818384; font-weight: bold;">Bandwidth Limit</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" name="bwlimit" placeholder="Mbps"
                                style="padding: 8px; border-radius: 4px; border: 1px solid #343536; background: #1a1a1b; color: white; flex: 1;">
                            <button type="submit"
                                style="padding: 8px; border-radius: 4px; border: none; background: #0079d3; color: white; cursor: pointer;">Set</button>
                        </div>
                    </form>
                </div>

                <!-- Scheduler -->
                <div>
                    <form action="/settings/scheduler" method="POST"
                        style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="font-size: 13px; color: #818384; font-weight: bold;">Quiet Hours Scheduler</label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" name="scheduler_enabled"> <span>Enable</span>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <input type="time" name="quiet_start" title="Start Time"
                                style="background:#1a1a1b; color:white; border:1px solid #343536; border-radius:4px;">
                            <span>to</span>
                            <input type="time" name="quiet_end" title="End Time"
                                style="background:#1a1a1b; color:white; border:1px solid #343536; border-radius:4px;">
                        </div>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <span style="font-size: 12px;">Limit:</span>
                            <input type="number" name="quiet_limit" placeholder="Mbps"
                                style="width: 60px; background:#1a1a1b; color:white; border:1px solid #343536; border-radius:4px;">
                            <button type="submit"
                                style="padding: 4px 8px; border-radius: 4px; border: none; background: #4caf50; color: white; cursor: pointer; font-size: 11px;">Save</button>
                        </div>
                    </form>
                </div>

                <!-- Notifications -->
                <div>
                    <form action="/settings/notifications" method="POST"
                        style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="font-size: 13px; color: #818384; font-weight: bold;">Notifications</label>
                        <input type="text" name="discord_webhook" placeholder="Discord Webhook URL"
                            style="padding: 6px; border-radius: 4px; border: 1px solid #343536; background: #1a1a1b; color: white;">
                        <div style="display: flex; gap: 5px;">
                            <input type="text" name="telegram_token" placeholder="TG Bot Token"
                                style="padding: 6px; flex:1; border-radius: 4px; border: 1px solid #343536; background: #1a1a1b; color: white;">
                            <input type="text" name="telegram_chat_id" placeholder="Chat ID"
                                style="padding: 6px; width: 60px; border-radius: 4px; border: 1px solid #343536; background: #1a1a1b; color: white;">
                        </div>
                        <button type="submit"
                            style="padding: 6px; border-radius: 4px; border: none; background: #7289da; color: white; cursor: pointer;">Update</button>
                    </form>
                </div>
            </div>
        </div>

        <h2 style="border-left-color: #818384;">Raw Engine Status</h2>
        <pre id="raw-status">{{.LsyncdStatus}}</pre>
    </div>

    <script>
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = wsProtocol + '//' + window.location.host + '/ws';
        let socket;

        function connect() {
            socket = new WebSocket(wsUrl);

            socket.onopen = function () {
                console.log("WS Connected");
                showToast("Connected to Server", "success");
                updateFavicon("active");
            };

            socket.onmessage = function (event) {
                const msg = JSON.parse(event.data);
                if (msg.type === "progress") {
                    updateProgress(msg.data);
                } else if (msg.type === "stats") {
                    const today = document.getElementById('stat-today');
                    const total = document.getElementById('stat-total');

                    // Remove skeleton
                    today.classList.remove('skeleton');
                    total.classList.remove('skeleton');

                    today.innerText = formatBytes(msg.data.Today);
                    total.innerText = formatBytes(msg.data.Total);
                } else if (msg.type === "daily") {
                    renderChart(msg.data);
                } else if (msg.type === "history_new") {
                    addHistoryItem(msg.data);
                }
            };

            socket.onclose = function (e) {
                showToast("Connection Lost", "error");
                updateFavicon("error");
                setTimeout(function () {
                    connect();
                }, 1000);
            };
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = msg;

            container.appendChild(toast);

            // Remove after 3s
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function updateFavicon(status) {
            const canvas = document.createElement('canvas');
            canvas.width = 32;
            canvas.height = 32;
            const ctx = canvas.getContext('2d');

            // Draw Circle
            ctx.beginPath();
            ctx.arc(16, 16, 16, 0, 2 * Math.PI);

            if (status === 'active') ctx.fillStyle = '#4caf50'; // Green
            else if (status === 'error') ctx.fillStyle = '#f44336'; // Red
            else if (status === 'paused') ctx.fillStyle = '#ffa726'; // Orange
            else ctx.fillStyle = '#818384'; // Gray

            ctx.fill();

            const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
            link.type = 'image/x-icon';
            link.rel = 'icon';
            link.href = canvas.toDataURL();
            document.getElementsByTagName('head')[0].appendChild(link);
        }

        function updateProgress(data) {
            const speedEl = document.getElementById('stat-speed');
            if (speedEl) speedEl.innerText = data.speed;
            const rawEl = document.getElementById('raw-status');
            if (rawEl) rawEl.innerText = data.status;

            const etaEl = document.getElementById('eta-display');
            if (etaEl) etaEl.innerText = "ETA: " + data.eta;
        }

        function addHistoryItem(item) {
            const list = document.getElementById('history-list');
            if (!list) return;
            const li = document.createElement('li');
            li.style = "display: flex; flex-direction: column; background: #272729; margin-bottom: 15px; padding: 15px; border-radius: 6px; border: 1px solid #343536; border-left: 4px solid #4caf50;";
            li.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <span class='badge badge-${item.Action}'>${item.Action}</span>
                    <span class='timestamp' style='font-size: 11px; color: #818384;'>${item.Time}</span>
                </div>
                <div class='path-cell' style='font-size: 14px; font-weight: 500; letter-spacing: 0.3px;'>
                    ${item.Path} <span style="font-size:10px; color:#818384;">(${item.Size})</span>
                </div>
            `;
            list.insertBefore(li, list.firstChild);
            if (list.children.length > 20) list.removeChild(list.lastChild);
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KiB', 'MiB', 'GiB', 'TiB', 'PiB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function renderChart(data) {
            const container = document.getElementById('traffic-chart');
            if (!container) return;
            container.innerHTML = ''; // Clear loading

            if (!data || data.length === 0) {
                container.innerHTML = '<div style="width:100%; text-align:center; color:#818384; align-self:center;">No data yet</div>';
                return;
            }

            data.forEach(item => {
                const wrapper = document.createElement('div');
                wrapper.style = "flex: 1; display: flex; flex-direction: column; height: 100%; justify-content: flex-end;";

                // Calculate height percentage. item.HeightPercent comes from backend 0-100
                // Use backend calculation for consistency

                wrapper.innerHTML = `
                    <div class="chart-bar" style="height: ${item.HeightPercent}%;">
                        <div class="chart-value">${item.Size}</div>
                    </div>
                    <div class="chart-label">${item.Date.slice(5)}</div> 
                `; // slice(5) to remove Year, show MM-DD

                container.appendChild(wrapper);
            });
        }



        connect();
    </script>
</body>

</html>